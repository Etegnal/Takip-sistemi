{% extends "base.html" %}

{% block title %}Admin Panel - Isı Takip Sistemi{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Kullanıcı Yönetimi</h5>
                </div>
                <div class="card-body">
                    <h6>Mevcut Kullanıcılar</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Kullanıcı Adı</th>
                                    <th>E-posta</th>
                                    <th>Rol</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if user.role == 'admin' else 'primary' }}">
                                            {{ user.role }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Bildirim & SMTP Ayarları</h5>
                </div>
                <div class="card-body">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label for="max_sicaklik" class="form-label">Maksimum Sıcaklık Eşiği (°C)</label>
                            <input type="number" class="form-control" id="max_sicaklik" name="max_sicaklik" value="{{ ayarlar.max_sicaklik }}" step="0.1" required>
                        </div>

                        <div class="mb-3">
                            <label for="admin_email" class="form-label">Genel Admin E-posta</label>
                            <input type="email" class="form-control" id="admin_email" name="admin_email" value="{{ ayarlar.admin_email }}" required>
                        </div>

                        <div class="row">
                            <div class="col-md-12"><label class="form-label fw-bold">Lokasyon Bazlı E-posta Adresleri</label></div>
                            <div class="col-md-4 mb-3">
                                <label for="email_ofis" class="form-label">Ofis (A/B)</label>
                                <input type="email" class="form-control" id="email_ofis" name="email_ofis" value="{{ ayarlar.email_ofis or '' }}" placeholder="ofis@example.com">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="email_depo" class="form-label">Depo</label>
                                <input type="email" class="form-control" id="email_depo" name="email_depo" value="{{ ayarlar.email_depo or '' }}" placeholder="depo@example.com">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="email_laboratuvar" class="form-label">Laboratuvar</label>
                                <input type="email" class="form-control" id="email_laboratuvar" name="email_laboratuvar" value="{{ ayarlar.email_laboratuvar or '' }}" placeholder="lab@example.com">
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="email_bildirim" name="email_bildirim" {{ 'checked' if ayarlar.email_bildirim }}>
                            <label class="form-check-label" for="email_bildirim">E-posta bildirimlerini etkinleştir</label>
                        </div>

                        <hr>
                        <h6 class="mb-3">SMTP Ayarları</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="smtp_server" class="form-label">SMTP Sunucusu</label>
                                <input type="text" class="form-control" id="smtp_server" name="smtp_server" value="{{ ayarlar.smtp_server or 'smtp.gmail.com' }}">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="smtp_port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="smtp_port" name="smtp_port" value="{{ ayarlar.smtp_port or 587 }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="smtp_email" class="form-label">SMTP Kullanıcı (Gönderen)</label>
                                <input type="email" class="form-control" id="smtp_email" name="smtp_email" value="{{ ayarlar.smtp_email or '' }}" placeholder="you@example.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="smtp_password" class="form-label">SMTP Şifre / Uygulama Şifresi</label>
                                <input type="password" class="form-control" id="smtp_password" name="smtp_password" value="{{ ayarlar.smtp_password or '' }}" placeholder="Uygulama şifresi">
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success"><i class="fas fa-save me-2"></i>Ayarları Kaydet</button>
                            <button type="button" id="testEmailBtn" class="btn btn-outline-primary"><i class="fas fa-paper-plane me-2"></i>Test Mail Gönder</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>

document.getElementById('settingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    fetch('/admin/update_settings', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            alert('Ayarlar kaydedildi');
            location.reload();
        } else {
            alert('Hata: ' + (res.message || 'Kaydedilemedi'));
        }
    })
    .catch(err => {
        alert('İstek hatası: ' + err);
    });
});

// Test e-posta
document.getElementById('testEmailBtn').addEventListener('click', function() {
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Gönderiliyor...';
    fetch('/admin/test_email', { method: 'POST' })
        .then(r => r.json())
        .then(res => { alert(res.message || (res.success ? 'Başarılı' : 'Başarısız')); })
        .catch(err => { alert('Hata: ' + err); })
        .finally(() => { this.disabled = false; this.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Test Mail Gönder'; });
});
</script>
{% endblock %}
